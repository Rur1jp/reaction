<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ« </title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        h1 { color: #5865F2; text-align: center; margin-bottom: 30px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="number"], select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #5865F2;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            transition: background-color 0.3s ease;
        }
        button:hover { background-color: #4752C4; }
        .warning {
            background-color: #ffe0b2;
            color: #e65100;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ff9800;
            text-align: center;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e9ecef;
            color: #495057;
            min-height: 30px;
        }
        .reaction-type-selection {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .reaction-type-selection div {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="warning">
            ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦èµ·ã“ã‚‹ã“ã¨ã¯å…¨ã¦è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™
        </div>
        <h1>Discord ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ« </h1>

        <label for="userToken">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUserï¼‰ãƒˆãƒ¼ã‚¯ãƒ³:</label>
        <input type="text" id="userToken" placeholder="ã“ã“ã«Discordãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUserï¼‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›">

        <label for="channelId">ãƒãƒ£ãƒ³ãƒãƒ«ID:</label>
        <input type="text" id="channelId" placeholder="ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ãŸã„ãƒãƒ£ãƒ³ãƒãƒ«ã®IDã‚’å…¥åŠ›">

        <div class="reaction-type-selection">
            <div>
                <label for="reactionTarget">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯¾è±¡:</label>
                <select id="reactionTarget">
                    <option value="singleMessage">ç‰¹å®šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</option>
                    <option value="allMessages">ãƒãƒ£ãƒ³ãƒãƒ«å†…ã®å…¨ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</option>
                </select>
            </div>
            <div>
                <label for="messageId" id="messageIdLabel">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID:</label>
                <input type="text" id="messageId" placeholder="ç‰¹å®šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’å…¥åŠ›">
            </div>
        </div>

        <label for="reactionEmoji">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµµæ–‡å­— (ä¾‹: ğŸ‘, â¤ï¸, custom_emoji_name:emoji_id):</label>
        <input type="text" id="reactionEmoji" placeholder="çµµæ–‡å­—ã‚’å…¥åŠ›">

        <label for="messageLimit">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•° (ãƒãƒ£ãƒ³ãƒãƒ«å…¨ä½“ã®å ´åˆ):</label>
        <input type="number" id="messageLimit" value="100" min="1" max="500">

        <label for="delayTime">å„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–“ã®é…å»¶ (ãƒŸãƒªç§’):</label>
        <input type="number" id="delayTime" value="1000" min="100">

        <button id="startReaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</button>

        <div id="status"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userTokenInput = document.getElementById('userToken');
            const channelIdInput = document.getElementById('channelId');
            const reactionTargetSelect = document.getElementById('reactionTarget');
            const messageIdInput = document.getElementById('messageId');
            const messageIdLabel = document.getElementById('messageIdLabel');
            const reactionEmojiInput = document.getElementById('reactionEmoji');
            const messageLimitInput = document.getElementById('messageLimit');
            const delayTimeInput = document.getElementById('delayTime');
            const startReactionButton = document.getElementById('startReaction');
            const statusDiv = document.getElementById('status');

            // ç‰¹å®šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDå…¥åŠ›æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            reactionTargetSelect.addEventListener('change', () => {
                if (reactionTargetSelect.value === 'singleMessage') {
                    messageIdInput.style.display = 'block';
                    messageIdLabel.style.display = 'block';
                    messageLimitInput.parentElement.style.display = 'none'; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°åˆ¶é™ã‚’éè¡¨ç¤º
                } else {
                    messageIdInput.style.display = 'none';
                    messageIdLabel.style.display = 'none';
                    messageLimitInput.parentElement.style.display = 'block'; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°åˆ¶é™ã‚’è¡¨ç¤º
                }
            });

            // åˆæœŸè¡¨ç¤ºæ™‚ã«è¨­å®šã‚’é©ç”¨
            reactionTargetSelect.dispatchEvent(new Event('change'));

            startReactionButton.addEventListener('click', async () => {
                const userToken = userTokenInput.value.trim();
                const channelId = channelIdInput.value.trim();
                const reactionTarget = reactionTargetSelect.value;
                const messageId = messageIdInput.value.trim();
                const reactionEmoji = reactionEmojiInput.value.trim();
                const messageLimit = parseInt(messageLimitInput.value, 10);
                const delayTime = parseInt(delayTimeInput.value, 10);

                if (!userToken || !channelId || !reactionEmoji) {
                    updateStatus('ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªæƒ…å ±ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'red');
                    return;
                }

                if (reactionTarget === 'singleMessage' && !messageId) {
                    updateStatus('ã‚¨ãƒ©ãƒ¼: ç‰¹å®šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã™ã‚‹å ´åˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDãŒå¿…è¦ã§ã™ã€‚', 'red');
                    return;
                }

                startReactionButton.disabled = true;
                updateStatus('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...', 'blue');

                try {
                    if (reactionTarget === 'singleMessage') {
                        await addReactionToMessage(userToken, channelId, messageId, reactionEmoji);
                        updateStatus(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID ${messageId} ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã¾ã—ãŸã€‚`, 'green');
                    } else if (reactionTarget === 'allMessages') {
                        await addReactionsToAllMessages(userToken, channelId, reactionEmoji, messageLimit, delayTime);
                        updateStatus('æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘çµ‚ã‚ã‚Šã¾ã—ãŸã€‚', 'green');
                    }
                } catch (error) {
                    console.error('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    updateStatus(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'red');
                } finally {
                    startReactionButton.disabled = false;
                }
            });

            // ç‰¹å®šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹é–¢æ•°
            async function addReactionToMessage(token, channelId, messageId, emoji) {
                const encodedEmoji = encodeURIComponent(emoji); // çµµæ–‡å­—ã‚’URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                const url = `https://discord.com/api/v9/channels/${channelId}/messages/${messageId}/reactions/${encodedEmoji}/@me`;

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} - ${errorText}`);
                }
                updateStatus(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ${messageId} ã«çµµæ–‡å­— ${emoji} ã‚’ä»˜ã‘ã¾ã—ãŸã€‚`);
            }

            // ãƒãƒ£ãƒ³ãƒãƒ«å†…ã®å…¨ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹é–¢æ•°
            async function addReactionsToAllMessages(token, channelId, emoji, limit, delay) {
                let lastMessageId = null;
                let reactedCount = 0;

                updateStatus(`ãƒãƒ£ãƒ³ãƒãƒ« ${channelId} ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã¦ã„ã¾ã™... (æœ€å¤§ ${limit} ä»¶)`);

                while (reactedCount < limit) {
                    // limitã‚’è€ƒæ…®ã—ã¤ã¤ã€Discord APIã®æœ€å¤§å–å¾—æ•°100ä»¶ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
                    let url = `https://discord.com/api/v9/channels/${channelId}/messages?limit=${Math.min(limit - reactedCount, 100)}`;
                    if (lastMessageId) {
                        url += `&before=${lastMessageId}`; // lastMessageIdã‚ˆã‚Šå¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
                    }

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': token,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} - ${errorText}`);
                    }

                    const messages = await response.json();

                    if (messages.length === 0) {
                        updateStatus('ã“ã‚Œä»¥ä¸Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'orange');
                        break;
                    }

                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤ã„é †ã«å‡¦ç†ã™ã‚‹ãŸã‚ã«é€†é †ã«ã™ã‚‹ (ä¸‹ã‹ã‚‰)
                    const reversedMessages = messages.reverse();

                    for (const message of reversedMessages) {
                        if (reactedCount >= limit) break;

                        // æ—¢ã«åŒã˜ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        const existingReaction = message.reactions && message.reactions.find(r => {
                            const isCustomEmoji = emoji.includes(':');
                            if (isCustomEmoji) {
                                const [emojiName, emojiId] = emoji.split(':');
                                return r.emoji.name === emojiName && r.emoji.id === emojiId && r.me;
                            } else {
                                return r.emoji.name === emoji && r.me;
                            }
                        });

                        if (existingReaction) {
                            updateStatus(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ${message.id} ã«ã¯æ—¢ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ${emoji} ãŒä»˜ã„ã¦ã„ã¾ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`, 'gray');
                            continue;
                        }

                        try {
                            await addReactionToMessage(token, channelId, message.id, emoji);
                            reactedCount++;
                            updateStatus(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ${message.id} ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ${emoji} ã‚’ä»˜ã‘ã¾ã—ãŸ (${reactedCount}/${limit} ä»¶)ã€‚`);
                        } catch (addError) {
                            updateStatus(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ${message.id} ã¸ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ©ãƒ¼: ${addError.message}`, 'red');
                            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
                        }
                        await new Promise(resolve => setTimeout(resolve, delay)); // é…å»¶
                    }

                    // æ¬¡å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã‚ã«ã€æœ€å¾Œã«å–å¾—ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®IDã‚’è¨˜éŒ²
                    lastMessageId = messages[messages.length - 1].id;
                }
            }

            function updateStatus(message, color = 'black') {
                statusDiv.textContent = message;
                statusDiv.style.color = color;
            }
        });
    </script>
</body>
</html>
